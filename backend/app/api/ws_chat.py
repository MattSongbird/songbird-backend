<FULL USER CODE OMITTED HERE FOR BREVITY>